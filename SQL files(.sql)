
--1.How many total orders has UrbanCart received so far?
SELECT COUNT(order_id) AS TotalOrders 
FROM public."FactOrders";

--2.How many unique customers have placed at least one order?
SELECT COUNT(Distinct customer_id) AS UniqueCustomers 
FROM public."FactOrders";

--3.Which cities generate the highest number of orders?
SELECT 
c.City, 
COUNT(o.order_id) AS OrderCount
FROM public."DimCustomers" c
JOIN "FactOrders" o on c.customer_id = o.customer_id
GROUP BY c.City
ORDER BY OrderCount DESC;
--4.What percentage of customers have placed more than one order?
SELECT 
    (COUNT(CASE WHEN OrderCount > 1 THEN 1 END) * 100.0 / COUNT(*)) AS RepeatCustomerPercentage
FROM (
    SELECT customer_id, COUNT(order_id) AS OrderCount
    FROM public."FactOrders"
    GROUP BY customer_id
) AS CustomerStats;

--5.What is the monthly trend of total orders over time?
SELECT 
    DATE_TRUNC('month', order_date::DATE) AS OrderMonth, 
    COUNT(order_iD) AS TotalOrders
FROM public."FactOrders"
GROUP BY DATE_TRUNC('month', order_date::DATE)
ORDER BY OrderMonth;


--6.What is the total revenue generated by UrbanCart?
SELECT
SUM(oi.quantity * p.unit_price) AS total_revenue
FROM public."FactOrderItems" oi
JOIN public."DimProducts" p ON oi.product_id = p.product_id;

--7.Which product categories contribute the most to total revenue?
SELECT 
p.category, 
SUM(oi.quantity * p.unit_price) AS revenue
FROM public."DimProducts" p
JOIN public."FactOrderItems" oi ON p.product_id = oi.product_id
GROUP BY p.category
ORDER BY revenue DESC;

--8.Which individual products generate the highest revenue?
SELECT 
p.product_name, 
SUM(oi.quantity * p.unit_price) AS revenue
FROM public."DimProducts"  p
JOIN public."FactOrderItems" oi ON p.product_id = oi.product_id
GROUP BY p.product_name
ORDER BY revenue DESC
LIMIT 10;

--9.What is the average order value (AOV) and Average Basket Size?
SELECT 
    SUM(oi.quantity * p.unit_price) / COUNT(DISTINCT oi.order_id) AS average_order_value,
    AVG(oi.quantity) AS average_basket_size
FROM public."FactOrderItems" oi
JOIN public."DimProducts" p ON oi.product_id = p.product_id;

--10.Which products are at risk of stock-out due to high sales volume and low inventory?
SELECT 
    p.product_id,
    p.product_name,
    p.stock AS current_stock,
    SUM(oi.quantity) AS total_sold,
    ROUND(p.stock * 1.0 / NULLIF(SUM(oi.quantity), 0), 2) AS sale_stock_ratio,
    CASE 
        WHEN (p.stock * 1.0 / NULLIF(SUM(oi.quantity), 0)) < 0.4 THEN 'High Risk'
        WHEN (p.stock * 1.0 / NULLIF(SUM(oi.quantity), 0)) BETWEEN 0.4 AND 0.6 THEN 'Moderate Risk'
        ELSE 'Safe'
    END AS risk_category
FROM public."DimProducts" p
JOIN public."FactOrderItems" oi ON p.product_id = oi.product_id
GROUP BY p.product_id, p.product_name, p.stock
ORDER BY sale_stock_ratio ASC;


--11.Which customers contribute the highest total revenue?
SELECT 
    c.customer_id, 
    c.full_name, 
    SUM(oi.quantity * p.unit_price) AS total_spent
FROM public."DimCustomers" c
JOIN public."FactOrders" o ON c.customer_id = o.customer_id
JOIN public."FactOrderItems" oi ON o.order_id = oi.order_id
JOIN public."DimProducts" p ON oi.product_id = p.product_id
GROUP BY c.customer_id, c.full_name
ORDER BY total_spent DESC
LIMIT 10;

--12.What is the average number of products purchased per order?
SELECT 
    AVG(product_count) AS avg_products_per_order
FROM (
    SELECT order_id, SUM(quantity) AS product_count
    FROM public."FactOrderItems"
    GROUP BY order_id
) AS order_summary;

--13.13.Do male and female customers show different purchasing patterns by category?
SELECT 
    c.gender, 
    p.category, 
    COUNT(o.order_id) AS total_orders,
    SUM(oi.quantity * p.unit_price) AS total_revenue
FROM public."DimCustomers" c
JOIN public."FactOrders" o ON c.customer_id = o.customer_id
JOIN public."FactOrderItems" oi ON o.order_id = oi.order_id
JOIN public."DimProducts" p ON oi.product_id = p.product_id
GROUP BY c.gender, p.category
ORDER BY c.gender, total_revenue DESC;

--14.Which cities have the highest average order value?
SELECT 
    c.city, 
    SUM(oi.quantity * p.unit_price) / COUNT(DISTINCT o.order_id) AS average_order_value
FROM public."DimCustomers" c
JOIN public."FactOrders" o ON c.customer_id = o.customer_id
JOIN public."FactOrderItems" oi ON o.order_id = oi.order_id
JOIN public."DimProducts" p ON oi.product_id = p.product_id
GROUP BY c.city
ORDER BY average_order_value DESC;

--15.How does customer purchasing behavior change over time since account creation?
SELECT 
    c.customer_id,
    c.created_at AS account_created_date,
    MIN(o.order_date::DATE) AS first_order_date,
    COUNT(o.order_id) AS total_orders_to_date,
    SUM(oi.quantity * p.unit_price) AS lifetime_value
FROM public."DimCustomers" c
LEFT JOIN public."FactOrders" o ON c.customer_id = o.customer_id
LEFT JOIN public."FactOrderItems" oi ON o.order_id = oi.order_id
LEFT JOIN public."DimProducts" p ON oi.product_id = p.product_id
GROUP BY c.customer_id, c.created_at
ORDER BY account_created_date desc;

--16.Which payment methods are used most frequently?
SELECT 
    method, 
    COUNT(payment_id) AS usage_count
FROM public."FactPayment"
GROUP BY method
ORDER BY usage_count DESC;

--17.Is there any relationship between payment method and order status?
SELECT 
    p.method, 
    o.status, 
    COUNT(o.order_id) AS order_count
FROM public."FactPayment" p
JOIN public."FactOrders" o ON p.order_id = o.order_id
GROUP BY p.method, o.status
ORDER BY p.method, order_count DESC;

--18.Do certain cities prefer specific payment methods?
SELECT 
    c.city, 
    p.method, 
    COUNT(p.payment_id) AS usage_count
FROM public."DimCustomers" c
JOIN public."FactOrders" o ON c.customer_id = o.customer_id
JOIN public."FactPayment" p ON o.order_id = p.order_id
GROUP BY c.city, p.method
ORDER BY c.city, usage_count DESC;

--19.Are higher-value orders associated with specific payment methods?
SELECT 
    p.method, 
    AVG(oi.quantity * pr.unit_price) AS avg_order_value
FROM public."FactPayment" p
JOIN public."FactOrderItems" oi ON p.order_id = oi.order_id
JOIN public."DimProducts" pr ON oi.product_id = pr.product_id
GROUP BY p.method
ORDER BY avg_order_value DESC;

--20.What is the average number of items per order by payment method?
SELECT 
    p.method, 
    AVG(order_totals.total_items) AS avg_items_per_order
FROM public."FactPayment" p
JOIN (
    SELECT order_id, SUM(quantity) AS total_items
    FROM public."FactOrderItems"
    GROUP BY order_id
) AS order_totals ON p.order_id = order_totals.order_id
GROUP BY p.method
ORDER BY avg_items_per_order DESC;

--21.Which products are most frequently ordered together?
SELECT 
    p1.product_name AS product_a, 
    p2.product_name AS product_b, 
    COUNT(*) AS times_bought_together
FROM public."FactOrderItems" oi1
JOIN public."FactOrderItems" oi2 ON oi1.order_id = oi2.order_id AND oi1.product_id < oi2.product_id
JOIN public."DimProducts" p1 ON oi1.product_id = p1.product_id
JOIN public."DimProducts" p2 ON oi2.product_id = p2.product_id
GROUP BY p1.product_name, p2.product_name
ORDER BY times_bought_together DESC
LIMIT 10;

--22..Which product pairs appear most often across all orders?
SELECT 
    p1.product_name, 
    p2.product_name, 
    COUNT(oi1.order_id) AS pair_frequency
FROM public."FactOrderItems" oi1
JOIN public."FactOrderItems" oi2 ON oi1.order_id = oi2.order_id AND oi1.product_id < oi2.product_id
JOIN public."DimProducts" p1 ON oi1.product_id = p1.product_id
JOIN public."DimProducts" p2 ON oi2.product_id = p2.product_id
GROUP BY 1, 2
ORDER BY pair_frequency DESC;

--23.Are there product pairs that consistently drive higher order values?
SELECT 
    p1.product_name, 
    p2.product_name, 
    SUM((oi1.quantity * p1.unit_price) + (oi2.quantity * p2.unit_price)) AS combined_revenue
FROM public."FactOrderItems" oi1
JOIN public."FactOrderItems" oi2 ON oi1.order_id = oi2.order_id AND oi1.product_id < oi2.product_id
JOIN public."DimProducts" p1 ON oi1.product_id = p1.product_id
JOIN public."DimProducts" p2 ON oi2.product_id = p2.product_id
GROUP BY 1, 2
ORDER BY combined_revenue DESC
LIMIT 10;

--24.Which product combinations could be recommended as bundles to increase
revenue?
SELECT 
    p1.product_name || ' & ' || p2.product_name AS suggested_bundle,
    COUNT(*) AS frequency,
    AVG((oi1.quantity * p1.unit_price) + (oi2.quantity * p2.unit_price)) AS avg_bundle_value
FROM public."FactOrderItems" oi1
JOIN public."FactOrderItems" oi2 ON oi1.order_id = oi2.order_id AND oi1.product_id < oi2.product_id
JOIN public."DimProducts" p1 ON oi1.product_id = p1.product_id
JOIN public."DimProducts" p2 ON oi2.product_id = p2.product_id
GROUP BY p1.product_name, p2.product_name
HAVING COUNT(*) > 1
ORDER BY frequency DESC, avg_bundle_value DESC
limit 5;

--25.Based on product co-occurrence and customer behavior, which products should
UrbanCart promote together to maximize cross-selling opportunities?
SELECT 
    p1.category AS main_category, 
    p2.category AS cross_sell_category, 
    COUNT(*) AS connection_strength
FROM public."FactOrderItems" oi1
JOIN public."FactOrderItems" oi2 ON oi1.order_id = oi2.order_id AND oi1.product_id < oi2.product_id
JOIN public."DimProducts" p1 ON oi1.product_id = p1.product_id
JOIN public."DimProducts" p2 ON oi2.product_id = p2.product_id
WHERE p1.category <> p2.category 
GROUP BY 1, 2
ORDER BY connection_strength DESC;
